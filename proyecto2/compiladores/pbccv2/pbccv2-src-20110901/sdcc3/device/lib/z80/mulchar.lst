                              1 ;--------------------------------------------------------------------------
                              2 ;  mulchar.s
                              3 ;
                              4 ;  Copyright (C) 2009, Philipp Klaus Krause
                              5 ;
                              6 ;  This library is free software; you can redistribute it and/or modify it
                              7 ;  under the terms of the GNU General Public License as published by the
                              8 ;  Free Software Foundation; either version 2.1, or (at your option) any
                              9 ;  later version.
                             10 ;
                             11 ;  This library is distributed in the hope that it will be useful,
                             12 ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
                             13 ;  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
                             14 ;  GNU General Public License for more details.
                             15 ;
                             16 ;  You should have received a copy of the GNU General Public License 
                             17 ;  along with this library; see the file COPYING. If not, write to the
                             18 ;  Free Software Foundation, 51 Franklin Street, Fifth Floor, Boston,
                             19 ;   MA 02110-1301, USA.
                             20 ;
                             21 ;  As a special exception, if you link this library with other files,
                             22 ;  some of which are compiled with SDCC, to produce an executable,
                             23 ;  this library does not by itself cause the resulting executable to
                             24 ;  be covered by the GNU General Public License. This exception does
                             25 ;  not however invalidate any other reasons why the executable file
                             26 ;   might be covered by the GNU General Public License.
                             27 ;--------------------------------------------------------------------------
                             28 
                             29         .area   _CODE
                             30 
                             31 ; This multiplication routine is similar to the one
                             32 ; from Rodnay Zaks, "Programming the Z80".
                             33 
                             34 ; Now replaced by a builtin for code generation, but
                             35 ; still called from some asm files in this directory.
   0000                      36 __muluchar_rrx_s::
   0000 21 03 00             37         ld      hl, #2+1
   0003 54                   38         ld      d, h
   0004 39                   39         add     hl, sp
   0005 5E                   40         ld      e, (hl)
   0006 2B                   41         dec     hl
   0007 66                   42         ld      h, (hl)
   0008 6A                   43         ld      l, d
   0009 06 08                44         ld      b, #8
   000B                      45 muluchar_rrx_s_loop:
   000B 29                   46         add     hl, hl
   000C 30 01                47         jr      nc, muluchar_rrx_s_noadd
   000E 19                   48         add     hl, de
   000F                      49 muluchar_rrx_s_noadd:
   000F 10 FA                50         djnz    muluchar_rrx_s_loop
   0011 C9                   51         ret
                             52 
                             53 ; operands have different sign
                             54 
   0012                      55 __mulsuchar_rrx_s::
   0012 21 03 00             56         ld      hl,#2+1
   0015 44                   57         ld      b, h
   0016 39                   58         add     hl,sp
                             59 
   0017 5E                   60         ld      e,(hl)
   0018 2B                   61         dec     hl
   0019 4E                   62         ld      c,(hl)
   001A 18 16                63         jr      signexte
                             64 
   001C                      65 __muluschar_rrx_s::
   001C 21 02 00             66         ld      hl,#2
   001F 44                   67         ld      b, h
   0020 39                   68         add     hl,sp
                             69 
   0021 5E                   70         ld      e,(hl)
   0022 23                   71         inc     hl
   0023 4E                   72         ld      c,(hl)
   0024 18 0C                73         jr      signexte
                             74 
                             75 ;; Originally from GBDK by Pascal Felber.
                             76 
   0026                      77 __mulschar_rrx_s::
   0026 21 03 00             78         ld      hl,#2+1
   0029 39                   79         add     hl,sp
                             80 
   002A 5E                   81         ld      e,(hl)
   002B 2B                   82         dec     hl
   002C 6E                   83         ld      l,(hl)
                             84 
                             85         ;; Fall through
   002D                      86 __mulschar_rrx_hds::
                             87         ;; Need to sign extend before going in.
   002D 4D                   88         ld      c,l
                             89 
   002E 7D                   90         ld      a,l
   002F 17                   91         rla
   0030 9F                   92         sbc     a,a
   0031 47                   93         ld      b,a
   0032                      94 signexte:
   0032 7B                   95         ld      a,e
   0033 17                   96         rla
   0034 9F                   97         sbc     a,a
   0035 57                   98         ld      d,a
                             99 
   0036 C3r00s00            100         jp      __mul16
                            101 
