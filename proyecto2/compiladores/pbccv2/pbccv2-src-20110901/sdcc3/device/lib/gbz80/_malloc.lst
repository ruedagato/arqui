                              1 ;--------------------------------------------------------
                              2 ; File Created by SDCC : free open source ANSI-C Compiler
                              3 ; Version 3.0.1 #6227 (Oct  2 2015) (Linux)
                              4 ; This file was generated Fri Oct  2 17:18:20 2015
                              5 ;--------------------------------------------------------
                              6 	.module _malloc
                              7 	.optsdcc -mgbz80
                              8 	
                              9 ;--------------------------------------------------------
                             10 ; Public variables in this module
                             11 ;--------------------------------------------------------
                             12 	.globl __sdcc_heap_init
                             13 	.globl _malloc
                             14 ;--------------------------------------------------------
                             15 ;  ram data
                             16 ;--------------------------------------------------------
                             17 	.area _DATA
                             18 ;--------------------------------------------------------
                             19 ; overlayable items in  ram 
                             20 ;--------------------------------------------------------
                             21 	.area _OVERLAY
                             22 ;--------------------------------------------------------
                             23 ; external initialized ram data
                             24 ;--------------------------------------------------------
                             25 ;--------------------------------------------------------
                             26 ; global & static initialisations
                             27 ;--------------------------------------------------------
                             28 	.area _HOME
                             29 	.area _GSINIT
                             30 	.area _GSFINAL
                             31 	.area _GSINIT
                             32 ;--------------------------------------------------------
                             33 ; Home
                             34 ;--------------------------------------------------------
                             35 	.area _HOME
                             36 	.area _HOME
                             37 ;--------------------------------------------------------
                             38 ; code
                             39 ;--------------------------------------------------------
                             40 	.area _CODE
                             41 ;../_malloc.c:59: _sdcc_heap_init(void)
                             42 ;	---------------------------------
                             43 ; Function _sdcc_heap_init
                             44 ; ---------------------------------
   0000                      45 __sdcc_heap_init_start::
   0000                      46 __sdcc_heap_init:
                             47 	
                             48 ;../_malloc.c:61: MEMHEADER *pbase = &_sdcc_heap_start;
                             49 ;../_malloc.c:62: unsigned int size = &_sdcc_heap_end - (char *)pbase;
   0000 3Er00                50 	ld	a,#<(__sdcc_heap_end)
   0002 D6r00                51 	sub	a,#<(__sdcc_heap_start)
   0004 4F                   52 	ld	c,a
   0005 3Es00                53 	ld	a,#>(__sdcc_heap_end)
   0007 DEs00                54 	sbc	a,#>(__sdcc_heap_start)
   0009 47                   55 	ld	b,a
                             56 ;../_malloc.c:64: pbase->next = (MEMHEADER *)((char *)pbase + size - HEADER_SIZE);
   000A 21r00s00             57 	ld	hl,#__sdcc_heap_start
   000D 09                   58 	add	hl,bc
   000E 4D                   59 	ld	c,l
   000F 44                   60 	ld	b,h
   0010 79                   61 	ld	a,c
   0011 C6 FA                62 	add	a,#0xFA
   0013 4F                   63 	ld	c,a
   0014 78                   64 	ld	a,b
   0015 CE FF                65 	adc	a,#0xFF
   0017 47                   66 	ld	b,a
   0018 11r00s00             67 	ld	de,#__sdcc_heap_start
   001B 79                   68 	ld	a,c
   001C 12                   69 	ld	(de),a
   001D 13                   70 	inc	de
   001E 78                   71 	ld	a,b
   001F 12                   72 	ld	(de),a
                             73 ;../_malloc.c:65: pbase->next->next = NULL; //And mark it as last
   0020 59                   74 	ld	e,c
   0021 50                   75 	ld	d,b
   0022 3E 00                76 	ld	a,#0x00
   0024 12                   77 	ld	(de),a
   0025 13                   78 	inc	de
   0026 3E 00                79 	ld	a,#0x00
   0028 12                   80 	ld	(de),a
                             81 ;../_malloc.c:66: pbase->prev       = NULL; //and mark first as first
   0029 11r02s00             82 	ld	de,#0x0002 + __sdcc_heap_start
   002C 3E 00                83 	ld	a,#0x00
   002E 12                   84 	ld	(de),a
   002F 13                   85 	inc	de
   0030 3E 00                86 	ld	a,#0x00
   0032 12                   87 	ld	(de),a
                             88 ;../_malloc.c:67: pbase->len        = 0;    //Empty and ready.
   0033 11r04s00             89 	ld	de,#0x0004 + __sdcc_heap_start
   0036 3E 00                90 	ld	a,#0x00
   0038 12                   91 	ld	(de),a
   0039 13                   92 	inc	de
   003A 3E 00                93 	ld	a,#0x00
   003C 12                   94 	ld	(de),a
   003D                      95 00101$:
                             96 	
   003D C9                   97 	ret
   003E                      98 __sdcc_heap_init_end::
                             99 ;../_malloc.c:71: malloc (unsigned int size)
                            100 ;	---------------------------------
                            101 ; Function malloc
                            102 ; ---------------------------------
   003E                     103 _malloc_start::
   003E                     104 _malloc:
   003E E8 F6               105 	lda	sp,-10(sp)
                            106 ;../_malloc.c:77: if (size>(0xFFFF-HEADER_SIZE))
   0040 F8 0C               107 	ldhl	sp,#12
   0042 3E F9               108 	ld	a, #0xF9
   0044 96                  109 	sub	a, (hl)
   0045 23                  110 	inc	hl
   0046 3E FF               111 	ld	a, #0xFF
   0048 9E                  112 	sbc	a, (hl)
   0049 D2r52s00            113 	jp	NC,00102$
                            114 ;../_malloc.c:79: return NULL; //To prevent overflow in next line
   004C 11 00 00            115 	ld	de,#0x0000
   004F C3rBCs01            116 	jp	00117$
   0052                     117 00102$:
                            118 ;../_malloc.c:82: size += HEADER_SIZE; //We need a memory for header too
   0052 F8 0D               119 	ldhl	sp,#13
   0054 2B                  120 	dec	hl
   0055 5E                  121 	ld	e,(hl)
   0056 23                  122 	inc	hl
   0057 56                  123 	ld	d,(hl)
   0058 21 06 00            124 	ld	hl,#0x0006
   005B 19                  125 	add	hl,de
   005C 7D                  126 	ld	a,l
   005D 54                  127 	ld	d,h
   005E F8 0C               128 	ldhl	sp,#12
   0060 77                  129 	ld	(hl),a
   0061 23                  130 	inc	hl
   0062 72                  131 	ld	(hl),d
                            132 ;../_malloc.c:83: current_header = &_sdcc_heap_start;
   0063 F8 08               133 	ldhl	sp,#8
   0065 36r00               134 	ld	(hl),#<(__sdcc_heap_start)
   0067 23                  135 	inc	hl
   0068 36s00               136 	ld	(hl),#>(__sdcc_heap_start)
                            137 ;../_malloc.c:132: }
   006A F3                  138 	di
                            139 ;../_malloc.c:87: while (1)
   006B                     140 00108$:
                            141 ;../_malloc.c:96: if ((((unsigned int)current_header->next) -
   006B F8 09               142 	ldhl	sp,#9
   006D 2B                  143 	dec	hl
   006E 5E                  144 	ld	e,(hl)
   006F 23                  145 	inc	hl
   0070 56                  146 	ld	d,(hl)
   0071 1A                  147 	ld	a,(de)
   0072 F8 02               148 	ldhl	sp,#2
   0074 77                  149 	ld	(hl),a
   0075 13                  150 	inc	de
   0076 1A                  151 	ld	a,(de)
   0077 23                  152 	inc	hl
   0078 77                  153 	ld	(hl),a
   0079 2B                  154 	dec	hl
   007A 7E                  155 	ld	a,(hl)
   007B 2B                  156 	dec	hl
   007C 2B                  157 	dec	hl
   007D 77                  158 	ld	(hl),a
   007E F8 03               159 	ldhl	sp,#3
   0080 7E                  160 	ld	a,(hl)
   0081 2B                  161 	dec	hl
   0082 2B                  162 	dec	hl
   0083 77                  163 	ld	(hl),a
                            164 ;../_malloc.c:97: ((unsigned int)current_header) -
   0084 F8 08               165 	ldhl	sp,#8
   0086 4E                  166 	ld	c,(hl)
   0087 23                  167 	inc	hl
   0088 46                  168 	ld	b,(hl)
   0089 F8 01               169 	ldhl	sp,#1
   008B 2B                  170 	dec	hl
   008C 5E                  171 	ld	e,(hl)
   008D 23                  172 	inc	hl
   008E 56                  173 	ld	d,(hl)
   008F 7B                  174 	ld	a,e
   0090 91                  175 	sub	a,c
   0091 5F                  176 	ld	e,a
   0092 7A                  177 	ld	a,d
   0093 98                  178 	sbc	a,b
   0094 77                  179 	ld	(hl),a
   0095 2B                  180 	dec	hl
   0096 73                  181 	ld	(hl),e
                            182 ;../_malloc.c:98: current_header->len) >= size)
   0097 F8 09               183 	ldhl	sp,#9
   0099 2B                  184 	dec	hl
   009A 5E                  185 	ld	e,(hl)
   009B 23                  186 	inc	hl
   009C 56                  187 	ld	d,(hl)
   009D 21 04 00            188 	ld	hl,#0x0004
   00A0 19                  189 	add	hl,de
   00A1 4D                  190 	ld	c,l
   00A2 44                  191 	ld	b,h
   00A3 59                  192 	ld	e,c
   00A4 50                  193 	ld	d,b
   00A5 1A                  194 	ld	a,(de)
   00A6 4F                  195 	ld	c,a
   00A7 13                  196 	inc	de
   00A8 1A                  197 	ld	a,(de)
   00A9 47                  198 	ld	b,a
   00AA F8 01               199 	ldhl	sp,#1
   00AC 2B                  200 	dec	hl
   00AD 5E                  201 	ld	e,(hl)
   00AE 23                  202 	inc	hl
   00AF 56                  203 	ld	d,(hl)
   00B0 7B                  204 	ld	a,e
   00B1 91                  205 	sub	a,c
   00B2 5F                  206 	ld	e,a
   00B3 7A                  207 	ld	a,d
   00B4 98                  208 	sbc	a,b
   00B5 47                  209 	ld	b,a
   00B6 4B                  210 	ld	c,e
   00B7 F8 0C               211 	ldhl	sp,#12
   00B9 79                  212 	ld	a, c
   00BA 96                  213 	sub	a, (hl)
   00BB 23                  214 	inc	hl
   00BC 78                  215 	ld	a, b
   00BD 9E                  216 	sbc	a, (hl)
   00BE DArD4s00            217 	jp	C,00104$
                            218 ;../_malloc.c:100: ret = &current_header->mem;
   00C1 F8 09               219 	ldhl	sp,#9
   00C3 2B                  220 	dec	hl
   00C4 5E                  221 	ld	e,(hl)
   00C5 23                  222 	inc	hl
   00C6 56                  223 	ld	d,(hl)
   00C7 21 06 00            224 	ld	hl,#0x0006
   00CA 19                  225 	add	hl,de
   00CB 7D                  226 	ld	a,l
   00CC 54                  227 	ld	d,h
   00CD F8 04               228 	ldhl	sp,#4
   00CF 77                  229 	ld	(hl),a
   00D0 23                  230 	inc	hl
   00D1 72                  231 	ld	(hl),d
                            232 ;../_malloc.c:101: break;
   00D2 18 1F               233 	jr	00109$
   00D4                     234 00104$:
                            235 ;../_malloc.c:103: current_header = current_header->next;    //else try next
   00D4 F8 03               236 	ldhl	sp,#3
   00D6 2B                  237 	dec	hl
   00D7 4E                  238 	ld	c,(hl)
   00D8 23                  239 	inc	hl
   00D9 46                  240 	ld	b,(hl)
   00DA F8 08               241 	ldhl	sp,#8
   00DC 71                  242 	ld	(hl),c
   00DD 23                  243 	inc	hl
   00DE 70                  244 	ld	(hl),b
                            245 ;../_malloc.c:104: if (!current_header->next)
   00DF 2B                  246 	dec	hl
   00E0 5E                  247 	ld	e,(hl)
   00E1 23                  248 	inc	hl
   00E2 56                  249 	ld	d,(hl)
   00E3 1A                  250 	ld	a,(de)
   00E4 4F                  251 	ld	c,a
   00E5 13                  252 	inc	de
   00E6 1A                  253 	ld	a,(de)
   00E7 47                  254 	ld	b,a
   00E8 B1                  255 	or	a,c
   00E9 C2r6Bs00            256 	jp	NZ,00108$
                            257 ;../_malloc.c:106: ret = NULL;
   00EC F8 04               258 	ldhl	sp,#4
   00EE 36 00               259 	ld	(hl),#0x00
   00F0 23                  260 	inc	hl
   00F1 36 00               261 	ld	(hl),#0x00
                            262 ;../_malloc.c:107: break;
   00F3                     263 00109$:
                            264 ;../_malloc.c:111: if (ret)
   00F3 F8 04               265 	ldhl	sp,#4
   00F5 7E                  266 	ld	a,(hl)
   00F6 23                  267 	inc	hl
   00F7 B6                  268 	or	a,(hl)
   00F8 CArB5s01            269 	jp	Z,00116$
                            270 ;../_malloc.c:113: if (!current_header->len)
   00FB F8 09               271 	ldhl	sp,#9
   00FD 2B                  272 	dec	hl
   00FE 5E                  273 	ld	e,(hl)
   00FF 23                  274 	inc	hl
   0100 56                  275 	ld	d,(hl)
   0101 21 04 00            276 	ld	hl,#0x0004
   0104 19                  277 	add	hl,de
   0105 4D                  278 	ld	c,l
   0106 44                  279 	ld	b,h
   0107 59                  280 	ld	e,c
   0108 50                  281 	ld	d,b
   0109 1A                  282 	ld	a,(de)
   010A F8 00               283 	ldhl	sp,#0
   010C 77                  284 	ld	(hl),a
   010D 13                  285 	inc	de
   010E 1A                  286 	ld	a,(de)
   010F 23                  287 	inc	hl
   0110 77                  288 	ld	(hl),a
   0111 2B                  289 	dec	hl
   0112 7E                  290 	ld	a,(hl)
   0113 23                  291 	inc	hl
   0114 B6                  292 	or	a,(hl)
   0115 C2r25s01            293 	jp	NZ,00113$
                            294 ;../_malloc.c:115: current_header->len = size; //for first allocation
   0118 59                  295 	ld	e,c
   0119 50                  296 	ld	d,b
   011A F8 0C               297 	ldhl	sp,#12
   011C 7E                  298 	ld	a,(hl)
   011D 12                  299 	ld	(de),a
   011E 13                  300 	inc	de
   011F 23                  301 	inc	hl
   0120 7E                  302 	ld	a,(hl)
   0121 12                  303 	ld	(de),a
   0122 C3rB5s01            304 	jp	00116$
   0125                     305 00113$:
                            306 ;../_malloc.c:120: new_header = (MEMHEADER * )((char *)current_header + current_header->len);
   0125 F8 09               307 	ldhl	sp,#9
   0127 2B                  308 	dec	hl
   0128 5E                  309 	ld	e,(hl)
   0129 23                  310 	inc	hl
   012A 56                  311 	ld	d,(hl)
   012B F8 00               312 	ldhl	sp,#0
   012D 7E                  313 	ld	a,(hl)
   012E 23                  314 	inc	hl
   012F 66                  315 	ld	h,(hl)
   0130 6F                  316 	ld	l,a
   0131 19                  317 	add	hl,de
   0132 4D                  318 	ld	c,l
   0133 44                  319 	ld	b,h
   0134 F8 06               320 	ldhl	sp,#6
   0136 71                  321 	ld	(hl),c
   0137 23                  322 	inc	hl
   0138 70                  323 	ld	(hl),b
                            324 ;../_malloc.c:121: new_header->next = current_header->next; //and plug it into the chain
   0139 23                  325 	inc	hl
   013A 23                  326 	inc	hl
   013B 2B                  327 	dec	hl
   013C 5E                  328 	ld	e,(hl)
   013D 23                  329 	inc	hl
   013E 56                  330 	ld	d,(hl)
   013F 1A                  331 	ld	a,(de)
   0140 F8 00               332 	ldhl	sp,#0
   0142 77                  333 	ld	(hl),a
   0143 13                  334 	inc	de
   0144 1A                  335 	ld	a,(de)
   0145 23                  336 	inc	hl
   0146 77                  337 	ld	(hl),a
   0147 F8 07               338 	ldhl	sp,#7
   0149 2B                  339 	dec	hl
   014A 5E                  340 	ld	e,(hl)
   014B 23                  341 	inc	hl
   014C 56                  342 	ld	d,(hl)
   014D F8 00               343 	ldhl	sp,#0
   014F 7E                  344 	ld	a,(hl)
   0150 12                  345 	ld	(de),a
   0151 13                  346 	inc	de
   0152 23                  347 	inc	hl
   0153 7E                  348 	ld	a,(hl)
   0154 12                  349 	ld	(de),a
                            350 ;../_malloc.c:122: new_header->prev = current_header;
   0155 F8 06               351 	ldhl	sp,#6
   0157 4E                  352 	ld	c,(hl)
   0158 23                  353 	inc	hl
   0159 46                  354 	ld	b,(hl)
   015A 03                  355 	inc	bc
   015B 03                  356 	inc	bc
   015C 59                  357 	ld	e,c
   015D 50                  358 	ld	d,b
   015E 23                  359 	inc	hl
   015F 7E                  360 	ld	a,(hl)
   0160 12                  361 	ld	(de),a
   0161 13                  362 	inc	de
   0162 23                  363 	inc	hl
   0163 7E                  364 	ld	a,(hl)
   0164 12                  365 	ld	(de),a
                            366 ;../_malloc.c:123: current_header->next  = new_header;
   0165 2B                  367 	dec	hl
   0166 5E                  368 	ld	e,(hl)
   0167 23                  369 	inc	hl
   0168 56                  370 	ld	d,(hl)
   0169 F8 06               371 	ldhl	sp,#6
   016B 7E                  372 	ld	a,(hl)
   016C 12                  373 	ld	(de),a
   016D 13                  374 	inc	de
   016E 23                  375 	inc	hl
   016F 7E                  376 	ld	a,(hl)
   0170 12                  377 	ld	(de),a
                            378 ;../_malloc.c:124: if (new_header->next)
   0171 2B                  379 	dec	hl
   0172 5E                  380 	ld	e,(hl)
   0173 23                  381 	inc	hl
   0174 56                  382 	ld	d,(hl)
   0175 1A                  383 	ld	a,(de)
   0176 4F                  384 	ld	c,a
   0177 13                  385 	inc	de
   0178 1A                  386 	ld	a,(de)
   0179 47                  387 	ld	b,a
   017A F8 00               388 	ldhl	sp,#0
   017C 7E                  389 	ld	a,(hl)
   017D 23                  390 	inc	hl
   017E B6                  391 	or	a,(hl)
   017F CAr8Es01            392 	jp	Z,00111$
                            393 ;../_malloc.c:126: new_header->next->prev = new_header;
   0182 03                  394 	inc	bc
   0183 03                  395 	inc	bc
   0184 59                  396 	ld	e,c
   0185 50                  397 	ld	d,b
   0186 F8 06               398 	ldhl	sp,#6
   0188 7E                  399 	ld	a,(hl)
   0189 12                  400 	ld	(de),a
   018A 13                  401 	inc	de
   018B 23                  402 	inc	hl
   018C 7E                  403 	ld	a,(hl)
   018D 12                  404 	ld	(de),a
   018E                     405 00111$:
                            406 ;../_malloc.c:128: new_header->len  = size; //mark as used
   018E F8 07               407 	ldhl	sp,#7
   0190 2B                  408 	dec	hl
   0191 5E                  409 	ld	e,(hl)
   0192 23                  410 	inc	hl
   0193 56                  411 	ld	d,(hl)
   0194 21 04 00            412 	ld	hl,#0x0004
   0197 19                  413 	add	hl,de
   0198 4D                  414 	ld	c,l
   0199 44                  415 	ld	b,h
   019A 59                  416 	ld	e,c
   019B 50                  417 	ld	d,b
   019C F8 0C               418 	ldhl	sp,#12
   019E 7E                  419 	ld	a,(hl)
   019F 12                  420 	ld	(de),a
   01A0 13                  421 	inc	de
   01A1 23                  422 	inc	hl
   01A2 7E                  423 	ld	a,(hl)
   01A3 12                  424 	ld	(de),a
                            425 ;../_malloc.c:129: ret = &new_header->mem;
   01A4 F8 07               426 	ldhl	sp,#7
   01A6 2B                  427 	dec	hl
   01A7 5E                  428 	ld	e,(hl)
   01A8 23                  429 	inc	hl
   01A9 56                  430 	ld	d,(hl)
   01AA 21 06 00            431 	ld	hl,#0x0006
   01AD 19                  432 	add	hl,de
   01AE 7D                  433 	ld	a,l
   01AF 54                  434 	ld	d,h
   01B0 F8 04               435 	ldhl	sp,#4
   01B2 77                  436 	ld	(hl),a
   01B3 23                  437 	inc	hl
   01B4 72                  438 	ld	(hl),d
   01B5                     439 00116$:
   01B5 FB                  440 	ei
                            441 ;../_malloc.c:133: return ret;
   01B6 F8 05               442 	ldhl	sp,#5
   01B8 2B                  443 	dec	hl
   01B9 5E                  444 	ld	e,(hl)
   01BA 23                  445 	inc	hl
   01BB 56                  446 	ld	d,(hl)
   01BC                     447 00117$:
   01BC E8 0A               448 	lda	sp,10(sp)
   01BE C9                  449 	ret
   01BF                     450 _malloc_end::
                            451 	.area _CODE
                            452 	.area _CABS
