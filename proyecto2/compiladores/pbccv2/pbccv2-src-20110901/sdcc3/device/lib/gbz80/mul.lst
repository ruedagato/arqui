                              1 ;--------------------------------------------------------------------------
                              2 ;  mul.s
                              3 ;
                              4 ;  Copyright (C) 2000, Michael Hope
                              5 ;
                              6 ;  This library is free software; you can redistribute it and/or modify it
                              7 ;  under the terms of the GNU General Public License as published by the
                              8 ;  Free Software Foundation; either version 2.1, or (at your option) any
                              9 ;  later version.
                             10 ;
                             11 ;  This library is distributed in the hope that it will be useful,
                             12 ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
                             13 ;  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
                             14 ;  GNU General Public License for more details.
                             15 ;
                             16 ;  You should have received a copy of the GNU General Public License 
                             17 ;  along with this library; see the file COPYING. If not, write to the
                             18 ;  Free Software Foundation, 51 Franklin Street, Fifth Floor, Boston,
                             19 ;   MA 02110-1301, USA.
                             20 ;
                             21 ;  As a special exception, if you link this library with other files,
                             22 ;  some of which are compiled with SDCC, to produce an executable,
                             23 ;  this library does not by itself cause the resulting executable to
                             24 ;  be covered by the GNU General Public License. This exception does
                             25 ;  not however invalidate any other reasons why the executable file
                             26 ;   might be covered by the GNU General Public License.
                             27 ;--------------------------------------------------------------------------
                             28 
                             29         ;; Originally from GBDK by Pascal Felber.
                             30 
                             31         .area   _CODE
                             32 
                             33 ; operands have different sign
                             34 
   0000                      35 __mulsuchar_rrx_s::
   0000 21 03 00             36         ld      hl,#2+1
   0003 44                   37         ld      b, h
   0004 39                   38         add     hl,sp
                             39 
   0005 5E                   40         ld      e,(hl)
   0006 2B                   41         dec     hl
   0007 4E                   42         ld      c,(hl)
   0008 18 16                43         jr      signexte
                             44 
   000A                      45 __muluschar_rrx_s::
   000A 21 02 00             46         ld      hl,#2
   000D 44                   47         ld      b, h
   000E 39                   48         add     hl,sp
                             49 
   000F 5E                   50         ld      e,(hl)
   0010 23                   51         inc     hl
   0011 4E                   52         ld      c,(hl)
   0012 18 0C                53         jr      signexte
                             54 
   0014                      55 __mulschar_rrx_s::
   0014 21 02 00             56         ld      hl,#2
   0017 39                   57         add     hl,sp
                             58 
   0018 5E                   59         ld      e,(hl)
   0019 23                   60         inc     hl
   001A 6E                   61         ld      l,(hl)
                             62 
                             63         ;; Fall through
   001B                      64 __mulschar_rrx_hds::
                             65         ;; Need to sign extend before going in.
   001B 4D                   66         ld      c,l
                             67 
   001C 7D                   68         ld      a,l
   001D 17                   69         rla
   001E 9F                   70         sbc     a,a
   001F 47                   71         ld      b,a
   0020                      72 signexte:
   0020 7B                   73         ld      a,e
   0021 17                   74         rla
   0022 9F                   75         sbc     a,a
   0023 57                   76         ld      d,a
                             77 
   0024 C3r42s00             78         jp      .mul16
                             79 
   0027                      80 __muluchar_rrx_s::
   0027 21 02 00             81         ld      hl,#2
   002A 39                   82         add     hl,sp
                             83 
   002B 5E                   84         ld      e,(hl)
                             85 
   002C 23                   86         inc     hl
   002D 4E                   87         ld      c,(hl)
                             88 
                             89         ;; Clear the top
   002E AF                   90         xor     a
   002F 57                   91         ld      d,a
   0030 47                   92         ld      b,a
                             93 
   0031 C3r42s00             94         jp      .mul16
                             95 
   0034                      96 __mulint_rrx_s::
   0034 21 02 00             97         ld      hl,#2
   0037 39                   98         add     hl,sp
                             99 
   0038 5E                  100         ld      e,(hl)
   0039 23                  101         inc     hl
   003A 56                  102         ld      d,(hl)
   003B 23                  103         inc     hl
   003C 7E                  104         ld      a,(hl)
   003D 23                  105         inc     hl
   003E 66                  106         ld      h,(hl)
   003F 6F                  107         ld      l,a
                            108 
                            109         ;; Fall through
                            110 
   0040                     111 __muluchar_rrx_hds::
   0040                     112 __mulint_rrx_hds::
                            113         ;; Parameters:
                            114         ;;      HL, DE (left, right irrelivent)
   0040 44                  115         ld      b,h
   0041 4D                  116         ld      c,l
                            117 
                            118         ;; 16-bit multiplication
                            119         ;;
                            120         ;; Entry conditions
                            121         ;;   BC = multiplicand
                            122         ;;   DE = multiplier
                            123         ;;
                            124         ;; Exit conditions
                            125         ;;   DE = less significant word of product
                            126         ;;
                            127         ;; Register used: AF,BC,DE,HL
   0042                     128 .mul16:
   0042 21 00 00            129         ld      hl,#0
   0045 78                  130         ld      a,b
                            131         ; ld c,c
   0046 06 10               132         ld      b,#16
                            133 
                            134         ;; Optimise for the case when this side has 8 bits of data or
                            135         ;; less.  This is often the case with support address calls.
   0048 B7                  136         or      a
   0049 C2r4Fs00            137         jp      NZ,1$
                            138 
   004C 06 08               139         ld      b,#8
   004E 79                  140         ld      a,c
   004F                     141 1$:
                            142         ;; Taken from z88dk, which originally borrowed from the
                            143         ;; Spectrum rom.
   004F 29                  144         add     hl,hl
   0050 CB 11               145         rl      c
   0052 17                  146         rla                     ;DLE 27/11/98
   0053 D2r57s00            147         jp      NC,2$
   0056 19                  148         add     hl,de
   0057                     149 2$:
   0057 05                  150         dec     b
   0058 20 F5               151         jr      NZ,1$
                            152 
                            153         ;; Return in DE
   005A 5D                  154         ld      e,l
   005B 54                  155         ld      d,h
                            156 
   005C C9                  157         ret
                            158 
